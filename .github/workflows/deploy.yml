name: Deploy

on:
  push:
    branches:
      - master
  pull_request:
    types: [opened, synchronize]

permissions:
  contents: read
  id-token: write
  deployments: write
  pull-requests: write

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Create GitHub Deployment (Preview)
      - name: Create GitHub Deployment
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        id: create_deployment
        with:
          script: |
            const { owner, repo } = context.repo;
            const ref = context.payload.pull_request.head.ref;

            try {
              const deployment = await github.rest.repos.createDeployment({
                owner,
                repo,
                ref,
                environment: `pr-${context.issue.number}`,
                auto_merge: false,
                required_contexts: [],
                transient_environment: true,
                description: `Preview for PR #${context.issue.number}`
              });

              if (deployment.status === 201) {
                return deployment.data.id;
              }
              console.log('Deployment creation returned status:', deployment.status);
              return null;
            } catch (error) {
              console.error('Error creating deployment:', error);
              return null;
            }

      - name: Set Deployment Status Pending
        if: github.event_name == 'pull_request' && steps.create_deployment.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const deployment_id = ${{ steps.create_deployment.outputs.result }};
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment_id,
              state: 'pending',
              description: 'Deploying to Cloud Run preview...',
            });

      - id: 'auth'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GC_WORKLOAD_IDENTITY_PROVIDER }}'
          service_account: '${{ secrets.GC_SERVICE_ACCOUNT }}'

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Configure Docker
        run: gcloud auth configure-docker asia-east1-docker.pkg.dev

      - name: Create Artifact Registry Repository
        run: |
          gcloud artifacts repositories describe cofacts-ai --location=asia-east1 || \
          gcloud artifacts repositories create cofacts-ai --repository-format=docker \
            --location=asia-east1 --description="Docker repository for cofacts-ai"

      - name: Build and Push Images
        env:
          PROJECT_ID: ${{ secrets.GC_PROJECT_ID }}
          SHA: ${{ github.sha }}
        run: |
          # Build frontend
          docker build -t asia-east1-docker.pkg.dev/$PROJECT_ID/cofacts-ai/frontend:$SHA -f Dockerfile .
          docker push asia-east1-docker.pkg.dev/$PROJECT_ID/cofacts-ai/frontend:$SHA

          # Build backend
          docker build -t asia-east1-docker.pkg.dev/$PROJECT_ID/cofacts-ai/backend:$SHA -f adk/Dockerfile adk
          docker push asia-east1-docker.pkg.dev/$PROJECT_ID/cofacts-ai/backend:$SHA

          echo "FRONTEND_IMAGE=asia-east1-docker.pkg.dev/$PROJECT_ID/cofacts-ai/frontend:$SHA" >> $GITHUB_ENV
          echo "BACKEND_IMAGE=asia-east1-docker.pkg.dev/$PROJECT_ID/cofacts-ai/backend:$SHA" >> $GITHUB_ENV

      - name: Prepare Traffic Block
        id: traffic
        run: |
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            # Get current revision serving 100% traffic or latest ready revision
            CURRENT_REV=$(gcloud run services describe cofacts-ai --region asia-east1 --format="value(status.traffic.first(percent=100).revisionName)" || echo "")
            TAG="pr-${{ github.event.number }}"

            if [ -z "$CURRENT_REV" ]; then
              # First deployment or service doesn't exist, default to 100% to new
              echo "TRAFFIC_BLOCK=traffic: [{percent: 100, latestRevision: true, tag: \"$TAG\"}]" >> $GITHUB_ENV
            else
              # JSON format for traffic block
              echo "TRAFFIC_BLOCK=traffic: [{revisionName: \"$CURRENT_REV\", percent: 100}, {latestRevision: true, percent: 0, tag: \"$TAG\"}]" >> $GITHUB_ENV
            fi
          else
            # Production: 100% to latest
            echo "TRAFFIC_BLOCK=traffic: [{latestRevision: true, percent: 100}]" >> $GITHUB_ENV
          fi

      - name: Generate Service YAML
        run: |
          envsubst '${FRONTEND_IMAGE} ${BACKEND_IMAGE} ${TRAFFIC_BLOCK}' < service.template.yaml > service.yaml
          cat service.yaml

      - name: Deploy to Cloud Run
        run: |
          gcloud run services replace service.yaml --region asia-east1

      - name: Get Preview URL
        if: github.event_name == 'pull_request'
        id: get_url
        run: |
          TAG="pr-${{ github.event.number }}"
          # Try to get URL from status.traffic
          URL=$(gcloud run services describe cofacts-ai --region asia-east1 --format="value(status.traffic.filter(tag='$TAG').url)" | head -n 1)

          if [ -z "$URL" ]; then
             # Fallback: construct from base URL
             BASE_URL=$(gcloud run services describe cofacts-ai --region asia-east1 --format="value(status.url)")
             # Basic construction
             URL="${BASE_URL/https:\/\//https:\/\/$TAG---}"
          fi
          echo "PREVIEW_URL=$URL" >> $GITHUB_ENV

      - name: Set Deployment Status Success
        if: github.event_name == 'pull_request' && success() && steps.create_deployment.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const deployment_id = ${{ steps.create_deployment.outputs.result }};
            const preview_url = process.env.PREVIEW_URL;

            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment_id,
              state: 'success',
              environment_url: preview_url,
              description: 'Preview is ready!',
            });

      - name: Set Deployment Status Failure
        if: github.event_name == 'pull_request' && failure() && steps.create_deployment.outputs.result != 'null'
        uses: actions/github-script@v7
        with:
          script: |
            const deployment_id = ${{ steps.create_deployment.outputs.result }};
            await github.rest.repos.createDeploymentStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              deployment_id: deployment_id,
              state: 'failure',
              description: 'Deployment failed.',
            });
